<root BTCPP_format="4">
    <!-- 포함될 BT 파일들 -->
    <!--<include path="./dribble.xml" />-->
    <include path="./subtrees/locate.xml" />
    <include path="./subtrees/cam_find_and_track_ball.xml" />
    <include path="./subtrees/striker.xml" />
    <include path="./subtrees/defender.xml" />
    <include path="./subtrees/goalkeeper.xml" />
    <include path="./subtrees/find_ball.xml" />
    <include path="./strategy_layer.xml" />


    <!-- 시작 -->
    <BehaviorTree ID="MainTree">
        <Sequence name="root">
            <RunOnce><Script code="control_state=1" /></RunOnce>

            <ReactiveSequence _while="control_state==1">

                <ReactiveSequence _while="gc_is_under_penalty" name="Penalty">
                    <SetVelocity x="0.0" y="0.0" theta="0.0" />
                    <SelfLocateEnterField />
                </ReactiveSequence>

                <ReactiveSequence _while="!gc_is_under_penalty" name="No_Penalty">
                    
                    <ReactiveSequence _while="gc_game_sub_state_type=='TIMEOUT'" name="Timeout">
                        <SetVelocity x="0.0" y="0.0" theta="0.0" />
                        <SelfLocateEnterField />
                    </ReactiveSequence>

                    <ReactiveSequence _while="gc_game_sub_state_type=='NONE'" name="Normal_Game">
                        
                        <Sequence _while="gc_game_state=='INITIAL'" name="Initial">
                            <AlwaysSuccess/>
                        </Sequence>

                        <ReactiveSequence _while="gc_game_state=='READY'" name="Ready">
                            <SubTree ID="CamFindAndTrackBall" _autoremap="true" />

                            <GoToPose _while="player_role == 'striker'" target_pos_x="-0.5" target_pos_y="0.0" target_pos_theta="0.0" turn_threshold="0.5" stop_threshold="0.1" v_limit="0.6" />
                            <GoToPose _while="player_role == 'defender'" target_pos_x="-2.5" target_pos_y="0.0" target_pos_theta="0.0" turn_threshold="0.5" stop_threshold="0.1" v_limit="0.6" />
                            <GoToPose _while="player_role == 'goal_keeper'" target_pos_x="-4.5" target_pos_y="0.0" target_pos_theta="0.0" turn_threshold="0.5" stop_threshold="0.1" v_limit="0.6" />
                            
                            <!-- <CalcKickDir /> -->
                            <SubTree ID="Locate" _autoremap="true" />
                        </ReactiveSequence>

                        <ReactiveSequence _while="gc_game_state=='SET'" name="Set">
                            <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                            <SubTree ID="Locate" _autoremap="true" />
                            <SetVelocity x="0.0" y="0.0" theta="0.0" />
                        </ReactiveSequence>

                        <ReactiveSequence _while="gc_game_state=='PLAY'" name="Play">
                            
                            <!-- 역할 전환 로직 -->
                            <RoleManager current_role="{player_role}" new_role="{player_role}" />
                            
                            <!-- 전략/전술 레이어 (모든 역할 공통 적용) -->
                            <SubTree ID="StrategyTree" _autoremap="true" />

                            <SubTree
                                ID="CamFindAndTrackBall"
                                _autoremap="true"
                                _while="decision != 'offtheball'" />

                            <ReactiveSequence>
                                <SubTree ID="Striker" _autoremap="true" _while="player_role == 'striker'" />
                                <SubTree ID="Defender" _autoremap="true" _while="player_role == 'defender'" />
                                <SubTree ID="Goalkeeper" _autoremap="true" _while="player_role == 'goal_keeper'" />
                            </ReactiveSequence>
                            <SubTree ID="Locate" _autoremap="true" />
                            
                        </ReactiveSequence>

                        <ReactiveSequence _while="gc_game_state=='END'" name="End">
                            <SetVelocity x="0.0" y="0.0" theta="0.0" />
                        </ReactiveSequence>

                    </ReactiveSequence>
                    <ReactiveSequence _while="gc_game_sub_state_type=='FREE_KICK' && gc_game_state=='PLAY'" name="Free_Kick">
                         <SetVelocity x="0.0" y="0.0" theta="0.0" />
                         <SubTree ID="Locate" _autoremap="true" />
                    </ReactiveSequence>

                    <ReactiveSequence _while="gc_game_sub_state=='GET_READY'">
                        <SubTree ID="Locate" _autoremap="true" _while="ball_location_known" />
                    </ReactiveSequence>

                    <ReactiveSequence _while="gc_game_sub_state=='SET'">
                        <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
                        <SubTree ID="Locate" _autoremap="true" _while="ball_location_known" />
                        <SetVelocity />
                    </ReactiveSequence>

                </ReactiveSequence>
            </ReactiveSequence>
        </Sequence>
    </BehaviorTree>
</root>
