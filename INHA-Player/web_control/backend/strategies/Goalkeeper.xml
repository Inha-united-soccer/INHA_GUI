<root BTCPP_format="4">
    <!-- <BehaviorTree ID="Goalkeeper"> -->
    <BehaviorTree ID="MainTree"> 
      <ReactiveSequence>
        
        <!-- 1. Self Localization (Flattened from locate.xml) -->
        <Sequence name="Locate">
           <SelfLocate mode="trust_direction" />
           <SelfLocate1M msecs_interval="300" max_dist="2.0" max_drift="1.5" />
           <SelfLocate2T msecs_interval="300" max_dist="2.0" max_drift="1.5" />
           <SelfLocatePT msecs_interval="300" max_dist="2.0" max_drift="1.5" />
           <SelfLocateLT msecs_interval="300" max_dist="2.0" max_drift="1.5" />
           <SelfLocate2X msecs_interval="300" max_dist="2.0" max_drift="1.5" />
           <SelfLocateBorder msecs_interval="300" max_dist="2.0" max_drift="1.5"/>
        </Sequence>
  
        <!-- 2. Vision (Flattened from cam_find_and_track_ball.xml) -->
        <!-- 공을 찾고 추적하는 로직 -->
        <Sequence name="Vision">
            <IfThenElse>
                <ScriptCondition name="IsBallKnown" code="ball_location_known" />
                <CamTrackBall />
                <CamFindBall />
            </IfThenElse>
        </Sequence>
  
        <!-- 3. Core Goalkeeper Logic (Flattened from goalkeeper.xml) -->
        <!-- 공이 필드 안에 있을 때 수비 동작 -->
        <ReactiveSequence _while="!ball_out">
            <Sequence>
              
              <!-- 0. 골대 복귀 우선 순위 (Return to Goal First) -->
              <GoToPose target_pos_x="4.0" target_pos_y="0.0" target_pos_theta="0.0" turn_threshold="0.5" stop_threshold="0.3" v_limit="0.8" />

              <!-- A. 행동 결정 (Hold vs Clear vs Find) -->
              <ReactiveSequence>
                <GoalieDecide decision_out="{decision}" decision_in="{decision}" ctPosx="-4.5" ctPosy="0.0" closer_margin="0.5" clearing_max="3.0"/>
                <!-- 공을 놓쳤을 때: 찾기 모드 -->
                <Sequence _while="decision=='find'">
                    <CamFindBall />
                </Sequence>
              </ReactiveSequence>
  
              <!-- B. 걷어내기 (Normal Clearing) -->
              <ReactiveSequence _while="decision == 'normal_clearing'">
                  <ReactiveSequence>
                    <PredictBallTraj R_meas="0.02" sigma_a="2.0" horizon="0.8" vel_decay="0.3" ctPosx="-4.5" ctPosy="0.0" P0_pos="0.1" P0_vel="0.1" drop_time="0.5" a_min="0.1" a_max="0.8" k_av="4.0"/>
                    <GoalieClearingDecide decision_out="{clearing_decision}" clearing_decision_in="{clearing_decision}" chase_threshold="0.5" ctPosx="-4.5" ctPosy="0.0" decision_in="{decision}"/>
                  </ReactiveSequence>
                  <!-- 걷어내기 위해 접근 -->
                  <Chase _while="clearing_decision == 'clearing_chase'" vx_limit="1.0" vy_limit="0.5" vtheta_limit="1.0" dist="0.15" safe_dist="0.35" />
                  <!-- 걷어내기 킥 -->
                  <Kick _while="clearing_decision == 'clearing_kick'" speed_limit="1.2" min_msec_kick="300" msecs_stablize="100" kick_type="one_touch" />
              </ReactiveSequence>
  
              <!-- C. 위급 걷어내기 (Critical Clearing) -->
              <ReactiveSequence _while="decision == 'critical_clearing'">
                  <ReactiveSequence>
                    <GoalieClearingDecide decision_out="{clearing_decision}" clearing_decision_in="{clearing_decision}" chase_threshold="0.5" ctPosx="-4.5" ctPosy="0.0" decision_in="{decision}"/>
                  </ReactiveSequence>
                  <ReactiveSequence _while="clearing_decision == 'clearing_chase'">
                    <CalcClearingDir/>
                    <ClearingChase vx_limit="0.7" vy_limit="0.5" vtheta_limit="1.0" dist="0.15" safeDist="0.35" p_gain="2.0"/>
                  </ReactiveSequence>
                  <Kick _while="clearing_decision == 'clearing_kick'" speed_limit="1.2" min_msec_kick="300" msecs_stablize="100" kick_type="one_touch" />
              </ReactiveSequence>
  
              <!-- D. 골대 방어 (Hold) -->
              <ReactiveSequence _while="decision == 'hold'">
                <PredictBallTraj R_meas="0.02" sigma_a="2.0" horizon="0.8" drop_time="0.5" vel_decay="0.3" ctPosx="-4.5" ctPosy="0.0" P0_pos="0.1" P0_vel="0.1" a_min="0.1" a_max="0.8" k_av="4.0"/>
                <CalcGoliePos ctPosx="-4.5" ctPosy="0.0" golie_radius="0.5"/>
                <GolieMove vx_high="1.0" vx_low="-0.4" vy_high="0.8" vy_low="-0.8" Kp="2.0" Kp_theta="4.0" stop_threshold="0.05" ctPosx="-4.5" ctPosy="0.0"/>
              </ReactiveSequence>
            </Sequence>
        </ReactiveSequence>
      </ReactiveSequence>
    </BehaviorTree>
  </root>
